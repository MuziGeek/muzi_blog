---

title: Day13

date: 2025/01/05 20ï¼š46ï¼š25

categories:

- [å­¦ä¹ æˆé•¿, ç¼–ç¨‹, é¢è¯•è®­ç»ƒè¥]

tags:

---
**2025-01-05**ğŸŒ±ä¸Šæµ·: â˜€ï¸   ğŸŒ¡ï¸+13Â°C ğŸŒ¬ï¸â†’13km/h

## Redis ä¸­å¦‚ä½•å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ

### æ€»ç»“åˆ†æ

åœ¨ Redis ä¸­å®ç°åˆ†å¸ƒå¼é”ï¼Œå¸¸è§åšæ³•æ˜¯å°† set ex nx å‘½ä»¤ä¸ lua è„šæœ¬ç»„åˆä½¿ç”¨ã€‚è¿™ä¸€æ–¹å¼èƒ½ç¡®ä¿å¤šä¸ªå®¢æˆ·ç«¯ä¸ä¼šåŒæ—¶è·å–åŒä¸€èµ„æºé”ï¼Œè¿˜èƒ½ä¿éšœå®‰å…¨è§£é”ä»¥åŠåœ¨æ„å¤–æƒ…å†µä¸‹è‡ªåŠ¨é‡Šæ”¾é” ã€‚

### æ‰©å±•çŸ¥è¯†

ä¸ºäº†èƒ½å¤Ÿæ›´å¥½çš„äº†è§£åˆ†å¸ƒå¼é”çš„å®ç°åŸç†åŠä¸ºä»€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½è¿›è¡Œé€æ­¥åˆ†æ

### æ‰‹å†™ä¸€ä¸ªåˆ†å¸ƒå¼é”

é¦–å…ˆåˆ†æä¸€ä¸‹åˆ†å¸ƒå¼é”å®ç°éƒ½éœ€è¦æ»¡è¶³ä»€ä¹ˆï¼Œå¯ä»¥åŸºäºJUCä¸­çš„AQSè§„èŒƒè¿›è¡Œå‚è€ƒ

#### åˆ†å¸ƒå¼é”æ‰€éœ€æ»¡è¶³çš„æ¡ä»¶

- **ç‹¬å æ€§**

- ä»»ä½•æ—¶åˆ»åªèƒ½ä¸”ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰

- **é«˜å¯ç”¨**

- åœ¨redisé›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸èƒ½å› ä¸ºæŸä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†è€Œå‡ºç°è·å–é”å’Œé‡Šæ”¾é”å¤±è´¥çš„æƒ…å†µ
- åœ¨é«˜å¹¶å‘è¯·æ±‚ä¸‹ï¼Œæ€§èƒ½ä¾æ—§ok

- **é˜²æ­»é”**

- æœç»æ­»é”ï¼Œå¿…é¡»è¦æœ‰è¶…æ—¶æ§åˆ¶æˆ–è€…æ’¤é”€æ“ä½œï¼Œæœ‰ä¸ªå…œåº•ç»ˆæ­¢è·³å‡ºæ–¹æ¡ˆ

- **ä¸ä¹±æŠ¢**

- é˜²æ­¢å¼ å† ææˆ´ï¼Œä¸èƒ½ç§ä¸‹é‡Šæ”¾äº†åˆ«äººçš„é”ï¼Œåªèƒ½è‡ªå·±åŠ çš„é”è‡ªå·±é‡Šæ”¾

- **é‡å…¥æ€§**

- åŒä¸€ä¸ªèŠ‚ç‚¹çš„åŒä¸€ä¸ªçº¿ç¨‹è·å¾—é”ä¹‹åï¼Œå®ƒå¯ä»¥å†æ¬¡è·å–è¿™ä¸ªé”

#### é€æ­¥åˆ†æ

ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºåˆ†å¸ƒå¼é”æˆ‘ä»¬ä¸€èˆ¬ç”¨setnxå‘½ä»¤è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯é’ˆå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œsetnxå¹¶ä¸å…¨é¢ï¼ˆè€ƒè™‘å¯é‡å…¥æ€§ï¼‰ã€‚

![](https://cdn.nlark.com/yuque/0/2023/png/26566882/1697012816577-f4cfb9f2-ff71-4fdb-a6b4-acec42e7ff78.png?x-oss-process=image%2Fformat%2Cwebp)

**JUCä¸­AQSé”çš„è§„èŒƒè½åœ°å‚è€ƒ+å¯é‡å…¥é”è€ƒè™‘+Luaè„šæœ¬+Rediså‘½ä»¤ä¸€æ­¥æ­¥å®ç°åˆ†å¸ƒå¼é”**

#### å®ç°ä¸€ä¸ªç®€å•çš„Redisåˆ†å¸ƒå¼é”ï¼ˆä½¿ç”¨setnxé€šè¿‡javaä»£ç å®ç°ï¼‰

```
public String sale()
{
    String retMessage = "";
    String key = "MuziRedisLock";
    String uuidValue = IdUtil.simpleUUID()+":"+Thread.currentThread().getId();

    Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, uuidValue);
    if(!flag)
    {
        //æš‚åœ20æ¯«ç§’ï¼Œè¿›è¡Œé€’å½’é‡è¯•.....
        try { TimeUnit.MILLISECONDS.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); }
        sale();
    }else{
        //æŠ¢é”æˆåŠŸçš„è¯·æ±‚çº¿ç¨‹ï¼Œè¿›è¡Œæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘æ“ä½œï¼Œæ‰£å‡åº“å­˜
        try
        {
            //1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
            String result = stringRedisTemplate.opsForValue().get("inventory001");
            //2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
            Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
            //3 æ‰£å‡åº“å­˜ï¼Œæ¯æ¬¡å‡å°‘ä¸€ä¸ª
            if(inventoryNumber > 0)
            {
                stringRedisTemplate.opsForValue().set("inventory001",String.valueOf(--inventoryNumber));
                retMessage = "æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“,åº“å­˜å‰©ä½™:"+inventoryNumber;
                System.out.println(retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port);
            }else{
                retMessage = "å•†å“å–å®Œäº†,o(â•¥ï¹â•¥)o";
            }
        }finally {
            stringRedisTemplate.delete(key);
        }
    }
    return retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port;
}
```

ä¸Šé¢ä»£ç å°±æ˜¯ä¸€ä¸ªç®€å•é€šè¿‡setnxå®ç°åˆ†å¸ƒå¼é”çš„æ¡ˆä¾‹ï¼Œä½†æ˜¯å­˜åœ¨é—®é¢˜ï¼Œ`é€’å½’é‡è¯•ï¼Œå®¹æ˜“å¯¼è‡´stackoverflowerrorï¼Œæ‰€ä»¥ä¸å¤ªæ¨èï¼›å¦å¤–ï¼Œé«˜å¹¶å‘å”¤é†’åæ¨èç”¨whileåˆ¤æ–­è€Œä¸æ˜¯if`

**è¿›ä¸€æ­¥ä¼˜åŒ–**

```

public String sale()
{
    String retMessage = "";

    String key = "MuziRedisLock";
    String uuidValue = IdUtil.simpleUUID()+":"+Thread.currentThread().getId();

    //ä¸ç”¨é€’å½’äº†ï¼Œé«˜å¹¶å‘ä¸‹å®¹æ˜“å‡ºé”™ï¼Œç”¨è‡ªæ—‹æ›¿ä»£é€’å½’æ–¹æ³•é‡è¯•è°ƒç”¨;ä¹Ÿä¸ç”¨ifäº†ï¼Œç”¨whileæ¥æ›¿ä»£
    while(!stringRedisTemplate.opsForValue().setIfAbsent(key, uuidValue))
    {
        //æš‚åœ20æ¯«ç§’ï¼Œè¿›è¡Œé€’å½’é‡è¯•.....
        try { TimeUnit.MILLISECONDS.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); }
    }

    //æŠ¢é”æˆåŠŸçš„è¯·æ±‚çº¿ç¨‹ï¼Œè¿›è¡Œæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘æ“ä½œï¼Œæ‰£å‡åº“å­˜
    try
    {
        //1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
        String result = stringRedisTemplate.opsForValue().get("inventory001");
        //2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
        Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
        //3 æ‰£å‡åº“å­˜ï¼Œæ¯æ¬¡å‡å°‘ä¸€ä¸ª
        if(inventoryNumber > 0)
        {
            stringRedisTemplate.opsForValue().set("inventory001",String.valueOf(--inventoryNumber));
            retMessage = "æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“,åº“å­˜å‰©ä½™:"+inventoryNumber;
            System.out.println(retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port);
        }else{
            retMessage = "å•†å“å–å®Œäº†,o(â•¥ï¹â•¥)o";
        }
    }finally {
        stringRedisTemplate.delete(key);
    }
    return retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port;
}
```

è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰“æ–­ç‚¹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å…³é—­æœåŠ¡æ¨¡ä»¿**æœºå™¨å®•æœº**ï¼Œå¯¼è‡´ä»£ç å±‚é¢æ ¹æœ¬**èµ°ä¸åˆ°finallyè¿™å—**ï¼Œé‚£è¿™æ ·å°±æ— æ³•ä¿è¯æ­£å¸¸è§£é”ï¼ˆæ— è¿‡æœŸæ—¶é—´è¯¥keyä¼šä¸€è‡´å­˜åœ¨ï¼‰ï¼ŒåŒæ—¶å› ä¸ºkeyæ²¡æœ‰è¢«åˆ é™¤ä¸€ç›´å­˜åœ¨ï¼Œæ‰€ä»¥éœ€è¦åŠ å…¥ä¸€ä¸ªè¿‡æœŸæ—¶é—´é™å®škeyçš„å­˜åœ¨ï¼Œç»§ç»­ä¼˜åŒ–ã€‚

#### å¢åŠ è¿‡æœŸæ—¶é—´

```

public String sale()
{
    String retMessage = "";

    String key = "MuziRedisLock";
    String uuidValue = IdUtil.simpleUUID()+":"+Thread.currentThread().getId();

    //æ”¹è¿›ç‚¹ï¼šåŠ é”å’Œè¿‡æœŸæ—¶é—´è®¾ç½®å¿…é¡»åŒä¸€è¡Œï¼Œä¿è¯åŸå­æ€§
    while(!stringRedisTemplate.opsForValue().setIfAbsent(key,uuidValue))
    {
        //æš‚åœ20æ¯«ç§’ï¼Œè¿›è¡Œé€’å½’é‡è¯•.....
        try { TimeUnit.MILLISECONDS.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); }
    }

    stringRedisTemplate.expire(key,30L,TimeUnit.SECONDS);

    //æŠ¢é”æˆåŠŸçš„è¯·æ±‚çº¿ç¨‹ï¼Œè¿›è¡Œæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘æ“ä½œï¼Œæ‰£å‡åº“å­˜
    try
    {
        //1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
        String result = stringRedisTemplate.opsForValue().get("inventory001");
        //2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
        Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
        //3 æ‰£å‡åº“å­˜ï¼Œæ¯æ¬¡å‡å°‘ä¸€ä¸ª
        if(inventoryNumber > 0)
        {
            stringRedisTemplate.opsForValue().set("inventory001",String.valueOf(--inventoryNumber));
            retMessage = "æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“,åº“å­˜å‰©ä½™:"+inventoryNumber;
            System.out.println(retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port);
        }else{
            retMessage = "å•†å“å–å®Œäº†,o(â•¥ï¹â•¥)o";
        }
    }finally {
        stringRedisTemplate.delete(key);
    }
    return retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port;
}
```

ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŠ é”çš„æ—¶å€™æˆ‘ä»¬åé¢ç»™é”æ·»åŠ äº†ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯ä»”ç»†è€ƒè™‘ï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨é—®é¢˜å°±æ˜¯**åŠ é”å’Œè®¾ç½®è¿‡æœŸæ—¶é—´**å¹¶ä¸æ˜¯åœ¨åŒä¸€è¡Œï¼Œè¿™å°±è¯´æ˜å¹¶**æ²¡æœ‰ä¿è¯åŸå­æ€§**ï¼Œå¯èƒ½å¯¼è‡´è¿‡æœŸæ—¶é—´æ·»åŠ å¤±è´¥ï¼Œæ‰€ä»¥è¿˜éœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚

```

public String sale()
{
    String retMessage = "";

    String key = "MuziRedisLock";
    String uuidValue = IdUtil.simpleUUID()+":"+Thread.currentThread().getId();

    //æ”¹è¿›ç‚¹ï¼šåŠ é”å’Œè¿‡æœŸæ—¶é—´è®¾ç½®å¿…é¡»åŒä¸€è¡Œï¼Œä¿è¯åŸå­æ€§
    while(!stringRedisTemplate.opsForValue().setIfAbsent(key,uuidValue,30L,TimeUnit.SECONDS))
    {
        //æš‚åœ20æ¯«ç§’ï¼Œè¿›è¡Œé€’å½’é‡è¯•.....
        try { TimeUnit.MILLISECONDS.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); }
    }


    //æŠ¢é”æˆåŠŸçš„è¯·æ±‚çº¿ç¨‹ï¼Œè¿›è¡Œæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘æ“ä½œï¼Œæ‰£å‡åº“å­˜
    try
    {
        //1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
        String result = stringRedisTemplate.opsForValue().get("inventory001");
        //2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
        Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
        //3 æ‰£å‡åº“å­˜ï¼Œæ¯æ¬¡å‡å°‘ä¸€ä¸ª
        if(inventoryNumber > 0)
        {
            stringRedisTemplate.opsForValue().set("inventory001",String.valueOf(--inventoryNumber));
            retMessage = "æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“,åº“å­˜å‰©ä½™:"+inventoryNumber;
            System.out.println(retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port);
        }else{
            retMessage = "å•†å“å–å®Œäº†,o(â•¥ï¹â•¥)o";
        }
    }finally {
        stringRedisTemplate.delete(key);
    }
    return retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port;
}
```

è¿™é‡Œå·²ç»è§£å†³äº†åŠ é”å’Œè®¾ç½®è¿‡æœŸæ—¶é—´åŸå­æ€§çš„é—®é¢˜ï¼Œä»”ç»†è€ƒè™‘ä¸‹è¿˜å­˜åœ¨ä»€ä¹ˆé—®é¢˜?

å‡è®¾çº¿ç¨‹ä¸€è·å–åˆ°é”ï¼Œä½†æ˜¯æ‰§è¡Œä¸šåŠ¡æ—¶é—´ï¼åŠ é”è¿‡æœŸæ—¶é—´ï¼Œçº¿ç¨‹ä¸€è¿˜åœ¨æ‰§è¡Œä¸­ï¼Œä½†æ˜¯é”å› ä¸ºè¿‡æœŸé‡Šæ”¾äº†ã€‚

çº¿ç¨‹äºŒè¿™æ—¶å€™åŠ é”æˆåŠŸäº†ï¼Œç„¶åçº¿ç¨‹äºŒä»»åŠ¡æ‰§è¡Œä¸­ï¼Œçº¿ç¨‹ä¸€ä»»åŠ¡æ‰§è¡Œå®Œæˆäº†ï¼Œç„¶åé‡Šæ”¾é”æˆåŠŸï¼Œä½†æ˜¯è¿™æ—¶å€™çš„é”å·²ç»æ˜¯çº¿ç¨‹äºŒåŠ çš„é”äº†ï¼Œå¯¼è‡´çº¿ç¨‹äºŒçš„é”è¢«çº¿ç¨‹ä¸€é‡Šæ”¾äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³ä¸€ä¸ªé—®é¢˜å°±æ˜¯è‡ªå·±åªèƒ½åˆ é™¤è‡ªå·±åŠ çš„é”ï¼Œéœ€è¦æ·»åŠ åˆ¤æ–­æ˜¯å¦è‡ªå·±çš„é”è¿›è¡Œæ“ä½œã€‚å…·ä½“æµç¨‹å¦‚å›¾ï¼š

![](https://cdn.nlark.com/yuque/0/2025/png/26566882/1736071967983-0a6ba7ef-92f0-4087-943a-79400a9bf33f.png)

#### é˜²æ­¢è¯¯åˆ keyçš„é—®é¢˜

```
public String sale()
{
    String retMessage = "";

    String key = "MuziRedisLock";
    String uuidValue = IdUtil.simpleUUID()+":"+Thread.currentThread().getId();

    while(!stringRedisTemplate.opsForValue().setIfAbsent(key,uuidValue,30L,TimeUnit.SECONDS))
    {
        //æš‚åœ20æ¯«ç§’ï¼Œè¿›è¡Œé€’å½’é‡è¯•.....
        try { TimeUnit.MILLISECONDS.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); }
    }

    //æŠ¢é”æˆåŠŸçš„è¯·æ±‚çº¿ç¨‹ï¼Œè¿›è¡Œæ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘æ“ä½œï¼Œæ‰£å‡åº“å­˜
    try
    {
        //1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
        String result = stringRedisTemplate.opsForValue().get("inventory001");
        //2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
        Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
        //3 æ‰£å‡åº“å­˜ï¼Œæ¯æ¬¡å‡å°‘ä¸€ä¸ª
        if(inventoryNumber > 0)
        {
            stringRedisTemplate.opsForValue().set("inventory001",String.valueOf(--inventoryNumber));
            retMessage = "æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“,åº“å­˜å‰©ä½™:"+inventoryNumber;
            System.out.println(retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port);
        }else{
            retMessage = "å•†å“å–å®Œäº†,o(â•¥ï¹â•¥)o";
        }
    }finally {
        //æ”¹è¿›ç‚¹ï¼Œåªèƒ½åˆ é™¤å±äºè‡ªå·±çš„keyï¼Œä¸èƒ½åˆ é™¤åˆ«äººçš„
        // åˆ¤æ–­åŠ é”ä¸è§£é”æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼ŒåŒä¸€ä¸ªæ‰è¡Œï¼Œè‡ªå·±åªèƒ½åˆ é™¤è‡ªå·±çš„é”ï¼Œä¸è¯¯åˆ ä»–äººçš„
        if(stringRedisTemplate.opsForValue().get(key).equalsIgnoreCase(uuidValue))
        {
            stringRedisTemplate.delete(key);
        }
    }
    return retMessage+"\t"+"æœåŠ¡ç«¯å£å·"+port;
}
```

ä»”ç»†è€ƒè™‘ä¸‹è¿˜å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ

æ ¹æ®æˆ‘ä»¬ä¸Šé¢ä¿è¯åŠ é”å’Œè®¾ç½®è¿‡æœŸæ—¶é—´çš„åŸå­æ€§åˆ†æï¼Œä¸éš¾çœ‹å‡ºè¿™é‡Œé”çš„åˆ¤æ–­é€»è¾‘å’Œåˆ é™¤é€»è¾‘åŒæ ·ä¸æ˜¯åŸå­å‘½ä»¤æ“ä½œã€‚è¿™é‡Œéœ€è¦æ€ä¹ˆåšå‘¢ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡åŸç”Ÿå‘½ä»¤å®ç°çš„è¯ï¼Œå¯ä»¥é€šè¿‡luaè„šæœ¬å®ç°åŸå­æ“ä½œã€‚è¿™é‡Œè¯´æ˜ä¸€ç‚¹**redisçš„åŸå­æ€§å’Œmysqläº‹åŠ¡çš„åŸå­æ€§å¹¶ä¸ä¸€è‡´**ï¼Œå…·ä½“åŒºåˆ«å¯ä»¥çœ‹ä¸‹é¢åˆ†æï¼š

|   |   |   |
|---|---|---|
|**æ¯”è¾ƒé¡¹**|**Redis**|**MySQL**|
|å•å‘½ä»¤åŸå­æ€§|åŸºäºå•çº¿ç¨‹æ¨¡å‹ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œä¿è¯å•ä¸ªå‘½ä»¤åŸå­æ€§ã€‚å¦‚`INCR`<br><br>å‘½ä»¤å¯åŸå­æ€§é€’å¢é”®å€¼ã€‚|é€šè¿‡è¡Œçº§é”å®ç°æŸäº›å•æ¡ SQL è¯­å¥å¯¹ç‰¹å®šè¡Œæ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œå¦‚`UPDATE...WHERE`<br><br>è¯­å¥ã€‚|
|äº‹åŠ¡åŸå­æ€§|é€šè¿‡`MULTI`<br><br>ã€`EXEC`<br><br>ç­‰å‘½ä»¤å®ç°ã€‚`MULTI`<br><br>åå‘½ä»¤å…¥é˜Ÿåˆ—ï¼Œ`EXEC`<br><br>æŒ‰åºæ‰§è¡Œã€‚æ‰§è¡Œ`EXEC`<br><br>å‰å‡ºé”™ï¼Œæ•´ä¸ªäº‹åŠ¡ä¸æ‰§è¡Œï¼›æ‰§è¡Œä¸­æŸä¸ªå‘½ä»¤å¤±è´¥ï¼ˆ2.6.5 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰é»˜è®¤ä¸å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œç»§ç»­æ‰§è¡Œåç»­å‘½ä»¤ã€‚|é€šè¿‡æ—¥å¿—ï¼ˆé‡åšæ—¥å¿—ã€å›æ»šæ—¥å¿—ï¼‰å’Œé”æœºåˆ¶å®ç°ã€‚äº‹åŠ¡å¼€å§‹è®°å½•æ“ä½œæ—¥å¿—ï¼ŒæˆåŠŸåˆ™æŒä¹…åŒ–å¹¶æäº¤ï¼Œå‡ºé”™åˆ™æ ¹æ®å›æ»šæ—¥å¿—æ’¤é”€æ“ä½œï¼Œä¿è¯äº‹åŠ¡åŸå­æ€§ã€‚|
|åº”ç”¨åœºæ™¯|å•å‘½ä»¤åŸå­æ€§é€‚ç”¨äºç®€å•è®¡æ•°ã€çŠ¶æ€æ ‡è®°ç­‰ï¼›äº‹åŠ¡åŸå­æ€§é€‚åˆå¯¹å¤šä¸ªæ“ä½œåŸå­æ€§å¤„ç†ï¼Œä½†å¯¹äº‹åŠ¡å›æ»šè¦æ±‚ä¸ä¸¥æ ¼çš„åœºæ™¯ï¼Œå¦‚ç”µå•†ç³»ç»Ÿä¸­åŒæ—¶æ›´æ–°å•†å“åº“å­˜å’Œç”¨æˆ·è®¢å•ä¿¡æ¯ã€‚|äº‹åŠ¡åŸå­æ€§é€‚ç”¨äºå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼Œå¦‚é“¶è¡Œè½¬è´¦ã€è®¢å•å¤„ç†ç­‰ï¼›è¡Œçº§é”åŸå­æ“ä½œé€‚ç”¨äºå¤šå¹¶å‘ä¸‹ç‰¹å®šè¡Œæ•°æ®ä¿®æ”¹éœ€ä¿è¯åŸå­æ€§çš„åœºæ™¯ï¼Œå¦‚å¤šç”¨æˆ·åº“å­˜ç®¡ç†ç³»ç»Ÿã€‚|
|åŸå­æ€§èŒƒå›´|ä¸»è¦ä½“ç°åœ¨å•å‘½ä»¤å’Œç®€å•äº‹åŠ¡ä¸Šã€‚|å¼ºè°ƒäº‹åŠ¡åŸå­æ€§ï¼Œäº‹åŠ¡ä¸­å¯åŒ…å«å¤æ‚å¤šè¡¨æ“ä½œã€‚|
|å›æ»šæœºåˆ¶|äº‹åŠ¡æ‰§è¡Œä¸­éƒ¨åˆ†å‘½ä»¤å¤±è´¥é»˜è®¤ä¸å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚|äº‹åŠ¡æ‰§è¡Œä¸­å‡ºç°é”™è¯¯è‡ªåŠ¨å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚|
|æ€§èƒ½|å•çº¿ç¨‹æ¨¡å‹ä¸‹åŸå­æ€§æ“ä½œæ€§èƒ½é«˜ï¼Œé€‚åˆé«˜å¹¶å‘ç®€å•æ“ä½œã€‚|äº‹åŠ¡åŸå­æ€§æ¶‰åŠæ—¥å¿—è®°å½•å’Œé”æœºåˆ¶ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒä½ã€‚|

å›å½’æ­£é¢˜ï¼Œé‚£å¦‚ä½•ç¼–å†™luaè„šæœ¬å‘¢ï¼Ÿä¸‹é¢æ˜¯æˆ‘ä¹‹å‰å­¦ä¹ luaè„šæœ¬çš„ä¸€äº›æ€»ç»“

[Luaè„šæœ¬æµ…è°ˆ](https://www.yuque.com/muzijinyouergun/uy1hur/wqgmalgd2g7ka4o0 "Luaè„šæœ¬æµ…è°ˆ")

#### luaè„šæœ¬ä¿è¯åŸå­æ€§

```
if redis.call("GET",KEYS[1]) == ARGV[1]
then
    return redis.call("DEL",KEYS[1])
else
    return 0
end
```

å®Œæ•´çš„javaä»£ç 

```
 public String sale()
{
String retMessage = "";
String key = "MuziRedisLock";
String uuidValue = IdUtil.simpleUUID()+":"+Thread.currentThread().getId();

while(!stringRedisTemplate.opsForValue().setIfAbsent(key, uuidValue,30L,TimeUnit.SECONDS))
{
//æš‚åœæ¯«ç§’
try { TimeUnit.MILLISECONDS.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); }
}

try
{
//1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
String result = stringRedisTemplate.opsForValue().get("inventory001");
//2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
//3 æ‰£å‡åº“å­˜
if(inventoryNumber > 0) {
stringRedisTemplate.opsForValue().set("inventory001",String.valueOf(--inventoryNumber));
retMessage = "æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“ï¼Œåº“å­˜å‰©ä½™: "+inventoryNumber+"\t"+uuidValue;
System.out.println(retMessage);
}else{
retMessage = "å•†å“å–å®Œäº†ï¼Œo(â•¥ï¹â•¥)o";
}
}finally {
String luaScript =
"if (redis.call('get',KEYS[1]) == ARGV[1]) then " +
"return redis.call('del',KEYS[1]) " +
"else " +
"return 0 " +
"end";
stringRedisTemplate.execute(new DefaultRedisScript<>(luaScript, Boolean.class), Arrays.asList(key), uuidValue);
}
return retMessage+"\t"+"æœåŠ¡ç«¯å£å·ï¼š"+port;
}
```

åˆ°è¿™é‡Œä¸€ä¸ªåˆ†å¸ƒå¼é”çš„å°±åŸºæœ¬å®Œæˆäº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦ç»§ç»­å®Œå–„ä¸‹ï¼Œè¿™é‡Œæƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ­£å¸¸ä½¿ç”¨çš„é”ä¸€èˆ¬éƒ½æœ‰ä»€ä¹ˆç‰¹æ€§ï¼Œæ¯”å¦‚`ReentrantLock`å’Œ`synchronize`ï¼Œå®ƒä»¬éƒ½å…·æœ‰å¯é‡å…¥æ€§ï¼Œæ‰€ä»¥æ¥ä¸‹ç»§ç»­ä¼˜åŒ–

#### å¯é‡å…¥é”

- å¯é‡å…¥é”åˆç§°é€’å½’é”ï¼ŒåŒä¸€çº¿ç¨‹å¤–å±‚æ–¹æ³•è·å–é”åï¼Œè¿›å…¥å†…å±‚æ–¹æ³•èƒ½è‡ªåŠ¨è·å–åŒä¸€é”å¯¹è±¡ï¼Œä¸ä¼šå› å·²è·é”æœªé‡Šæ”¾è€Œé˜»å¡ã€‚
- Java é‡Œ `ReentrantLock` å’Œ `synchronized` å‡ä¸ºå¯é‡å…¥é”ï¼Œè¯¥ç‰¹æ€§å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚
- å¯¹å¯é‡å…¥é”è¿›è¡Œ AQS æºç åˆ†æï¼Œæœ‰å‡ æ¬¡ `lock` å°±éœ€å¯¹åº”å‡ æ¬¡ `unlock`ã€‚
- é’ˆå¯¹ `ReentrantLock`ï¼ˆæ˜¾å¼é”ï¼‰ä¸ `synchronized`ï¼ˆéšå¼é”ï¼‰çš„å¯é‡å…¥é”è®¡æ•°é—®é¢˜ï¼ŒRedis çš„ hash æ•°æ®ç±»å‹ï¼ˆK,K,Vï¼‰èƒ½æ›´å¥½è§£å†³åˆ†å¸ƒå¼é”çš„å¯é‡å…¥é—®é¢˜ ã€‚

é‚£ä¹ˆæˆ‘ä»¬å°±é€šè¿‡hashæ•°æ®ç±»å‹çš„æ“ä½œè¿›è¡Œæ¨¡æ‹Ÿ

1. `hset key field value`
2. `hset redisé”åå­—(MuziRedisLock) æŸä¸ªè¯·æ±‚çº¿ç¨‹çš„UUID+ThreadID åŠ é”çš„æ¬¡æ•°`

```
127.0.0.1:6379> HEXISTS MuziRedisLock 1111-2222
(integer) 0
127.0.0.1:6379> HSET MuziRedisLock 1111-2222 1
(integer) 1
127.0.0.1:6379> HINCRBY MuziRedisLock 1111-2222 1
(integer) 2
127.0.0.1:6379> HINCRBY MuziRedisLock 1111-2222 1
(integer) 3
127.0.0.1:6379> HGET MuziRedisLock 1111-2222
"3"
127.0.0.1:6379> HINCRBY MuziRedisLock 1111-2222 -1
(integer) 2
127.0.0.1:6379> HINCRBY MuziRedisLock 1111-2222 -1
(integer) 1
127.0.0.1:6379> HINCRBY MuziRedisLock 1111-2222 -1
(integer) 0
127.0.0.1:6379> hget MuziRedisLock 1111-2222
"0"
```

**ç”±ä¸Šæ€»ç»“ï¼Œsetnxåªèƒ½è§£å†³æœ‰æ— çš„é—®é¢˜ï¼Œä½†æ˜¯hsetä¸ä½†è§£å†³æœ‰æ— ï¼Œè¿˜å¯ä»¥è§£å†³å¯é‡å…¥é—®é¢˜ï¼é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯ç¼–å†™luaè„šæœ¬**

#### åŠ é”luaè„šæœ¬ï¼ˆä½¿ç”¨hashæ•°æ®ç±»å‹ï¼‰

**åˆ†æåŠ é”è¿‡ç¨‹**

1. **åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨**ï¼šä½¿ç”¨ `EXISTS KEY` å‘½ä»¤åˆ¤æ–­ Redis åˆ†å¸ƒå¼é”çš„é”®ï¼ˆ`KEY`ï¼‰æ˜¯å¦å­˜åœ¨ã€‚

- **ä¸å­˜åœ¨æ—¶**ï¼šè‹¥è¿”å›é›¶ï¼Œè¯´æ˜é”ä¸å­˜åœ¨ï¼Œæ­¤æ—¶é€šè¿‡ `HSET MuziRedisLock 0c90d37cb6ec42268861b3d739f8b3a8:1 1` å‘½ä»¤ï¼Œä»¥ `HSET` æ–¹å¼æ–°å»ºä¸€ä¸ªå±äºå½“å‰çº¿ç¨‹çš„é”ï¼Œå…¶ä¸­é”®ä¸º `MuziRedisLock`ï¼Œå€¼ä¸ºå½“å‰çº¿ç¨‹çš„ `UUID:ThreadID`ï¼ˆå¦‚ `0c90d37cb6ec42268861b3d739f8b3a8:1`ï¼‰ï¼Œå¹¶å°†é”çš„ç›¸å…³è®¡æ•°ç­‰ä¿¡æ¯è®¾ä¸º `1`ã€‚
- **å­˜åœ¨æ—¶**ï¼šè‹¥ `EXISTS KEY` è¿”å›ä¸€ï¼Œè¯´æ˜å·²ç»æœ‰é”å­˜åœ¨ï¼Œéœ€è¿›ä¸€æ­¥åˆ¤æ–­è¯¥é”æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹è‡ªå·±çš„ã€‚

2. **åˆ¤æ–­é”å½’å±**ï¼šä½¿ç”¨ `HEXISTS MuziRedisLock 0c90d37cb6ec42268861b3d739f8b3a8:1` å‘½ä»¤è¿›è¡Œåˆ¤æ–­ã€‚

- **ä¸æ˜¯è‡ªå·±çš„é”**ï¼šè‹¥è¿”å›é›¶ï¼Œè¯´æ˜è¯¥é”ä¸æ˜¯å½“å‰çº¿ç¨‹çš„ã€‚
- **æ˜¯è‡ªå·±çš„é”**ï¼šè‹¥è¿”å›ä¸€ï¼Œè¯´æ˜æ˜¯å½“å‰çº¿ç¨‹è‡ªå·±çš„é”ï¼Œæ­¤æ—¶é€šè¿‡ `HINCRBY MuziRedisLock 0c90d37cb6ec42268861b3d739f8b3a8:1 1` å‘½ä»¤ï¼Œä½¿ç”¨ `HINCRBY` å¯¹è¯¥é”çš„ç›¸å…³å­—æ®µï¼ˆä»¥å½“å‰çº¿ç¨‹çš„ `UUID:ThreadID` ä¸ºå­—æ®µï¼‰è¿›è¡Œè‡ªå¢ `1` æ¬¡ï¼Œè¡¨ç¤ºé”çš„é‡å…¥ã€‚

```
if redis.call('exists',KEYS[1]) == 0 or redis.call('hexists',KEYS[1],ARGV[1]) == 1 
then 
  redis.call('hincrby',KEYS[1],ARGV[1],1) 
  redis.call('expire',KEYS[1],ARGV[2]) 
  return 1 
else
  return 0
end
```

#### åˆ†æè§£é”è¿‡ç¨‹

1. **åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨ï¼š**é€šè¿‡ `HEXISTS MuziRedisLock 0c90d37cb6ec42268861b3d739f8b3a8:1` æ£€æŸ¥é”æ˜¯å¦å­˜åœ¨åŠå½’å±ã€‚

- **è‹¥è¿”å›é›¶**ï¼Œè¡¨æ˜æ— é”ï¼Œç¨‹åºå—è¿”å› `nil`ï¼Œè§£é”æ“ä½œæ— æ³•è¿›è¡Œã€‚
- **è‹¥è¿”å›éé›¶**ï¼Œè¯´æ˜æœ‰é”ä¸”ä¸ºè‡ªèº«æŒæœ‰ã€‚

2. **åˆ¤æ–­é”å½’å±ï¼š**å¯¹äºæœ‰é”ä¸”æ˜¯è‡ªå·±çš„æƒ…å†µï¼Œè°ƒç”¨ `HINCRBY` å‘½ä»¤ï¼Œå°†å¯¹åº”å­—æ®µå€¼æ¯æ¬¡å‡ `1` è¿›è¡Œè§£é”æ“ä½œï¼Œå³ `HINCRBY zzyyRedisLock 0c90d37cb6ec42268861b3d739f8b3a8:1 -1`ã€‚
3. æŒç»­æ‰§è¡Œä¸Šè¿°è§£é”æ“ä½œï¼Œç›´è‡³å­—æ®µå€¼å˜ä¸ºé›¶ï¼Œæ­¤æ—¶å¯ä½¿ç”¨ `del` å‘½ä»¤åˆ é™¤é” `key`ï¼ˆ`del zzyyRedisLock`ï¼‰ï¼Œå®Œæˆé”çš„é‡Šæ”¾ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹å¯è·å–è¯¥é”ï¼Œä¿éšœåˆ†å¸ƒå¼é”çš„æ­£ç¡®æ€§ä¸å¯é æ€§ï¼Œé¿å…èµ„æºæ³„æ¼å’Œæ­»é”ç­‰é—®é¢˜ã€‚

```
if redis.call('HEXISTS',KEYS[1],ARGV[1]) == 0 
then
  return nil
elseif redis.call('HINCRBY',KEYS[1],ARGV[1],-1) == 0 then
  return redis.call('del',KEYS[1])
else
  return 0
end
```

æ•´åˆè¿›javaä»£ç ä¸­

```
//@Component å¼•å…¥DistributedLockFactoryå·¥å‚æ¨¡å¼ï¼Œä»å·¥å‚è·å¾—å³å¯
public class RedisDistributedLock implements Lock {
    private StringRedisTemplate stringRedisTemplate;

    private String lockName;//KEYS[1]
    private String uuidValue;//ARGV[1]
    private long expireTime;//ARGV[2]


    public RedisDistributedLock(StringRedisTemplate stringRedisTemplate, String lockName, String uuid) {
        this.stringRedisTemplate = stringRedisTemplate;
        this.lockName = lockName;
        this.uuidValue = uuid + ":" + Thread.currentThread().getId();
        this.expireTime = 30L;
    }

    @Override
    public void lock() {
        tryLock();
    }

    @Override
    public boolean tryLock() {
        try {
            tryLock(-1L, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        if (time == -1L) {
            String script =
                    "if redis.call('exists',KEYS[1]) == 0 or redis.call('hexists',KEYS[1],ARGV[1]) == 1 then    " +
                            "redis.call('hincrby',KEYS[1],ARGV[1],1)    " +
                            "redis.call('expire',KEYS[1],ARGV[2])    " +
                            "return 1  " +
                            "else   " +
                            "return 0 " +
                            "end";
            System.out.println("lockName:" + lockName + "\t" + "uuidValue:" + uuidValue);

            while (!stringRedisTemplate.execute(new DefaultRedisScript<>(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) {
                //æš‚åœ60æ¯«ç§’
                try {
                    TimeUnit.MILLISECONDS.sleep(60);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            //æ–°å»ºä¸€ä¸ªåå°æ‰«æç¨‹åºï¼Œæ¥åšæŒkeyç›®å‰çš„ttlï¼Œæ˜¯å¦åˆ°æˆ‘ä»¬è§„å®šçš„1/2 1/3æ¥å®ç°ç»­æœŸ
            renewExpire();
            return true;
        }
        return false;
    }


    @Override
    public void unlock() {
        System.out.println("unlock(): lockName:" + lockName + "\t" + "uuidValue:" + uuidValue);
        String script =
                "if redis.call('HEXISTS',KEYS[1],ARGV[1]) == 0 then    " +
                        "return nil  " +
                        "elseif redis.call('HINCRBY',KEYS[1],ARGV[1],-1) == 0 then    " +
                        "return redis.call('del',KEYS[1])  " +
                        "else    " +
                        "return 0 " +
                        "end";
        // nil = false 1 = true 0 = false
        Long flag = stringRedisTemplate.execute(new DefaultRedisScript<>(script, Long.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime));

        if (null == flag) {
            throw new RuntimeException("this lock doesn't existsï¼Œo(â•¥ï¹â•¥)o");
        }
    }
                                      
}
```

é‡å…¥æ€§å·²ç»è§£å†³äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰è€ƒè™‘åˆ°å¯èƒ½å‡ºç°çš„ä¸€ç§æƒ…å†µï¼Œä¸šåŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼Œé”å°±è¿‡æœŸäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥è€ƒè™‘å¦‚ä½•å®ç°ç»­æœŸåŠŸèƒ½ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ`**çœ‹é—¨ç‹—**`çš„å®ç°åŸç†ï¼Œé€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ä¸æ–­åˆ·æ–°è¿‡æœŸæ—¶é—´ã€‚

#### è‡ªåŠ¨ç»­æœŸ

ç¼–å†™luaè„šæœ¬ï¼Œåˆ¤æ–­é”æ˜¯å¦å­˜åœ¨

```
if redis.call('HEXISTS',KEYS[1],ARGV[1]) == 1 then
  return redis.call('expire',KEYS[1],ARGV[2])
else
  return 0
end
```

javaä»£ç 

```
private void renewExpire() {
    String script =
            "if redis.call('HEXISTS',KEYS[1],ARGV[1]) == 1 then     " +
                    "return redis.call('expire',KEYS[1],ARGV[2]) " +
                    "else     " +
                    "return 0 " +
                    "end";

    new Timer().schedule(new TimerTask() {
        @Override
        public void run() {
            if (stringRedisTemplate.execute(new DefaultRedisScript<>(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) {
                renewExpire();
            }
        }
    }, (this.expireTime * 1000) / 3);
}
```

```
public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
    if (time == -1L) {
        String script =
                "if redis.call('exists',KEYS[1]) == 0 or redis.call('hexists',KEYS[1],ARGV[1]) == 1 then    " +
                        "redis.call('hincrby',KEYS[1],ARGV[1],1)    " +
                        "redis.call('expire',KEYS[1],ARGV[2])    " +
                        "return 1  " +
                        "else   " +
                        "return 0 " +
                        "end";
        System.out.println("lockName:" + lockName + "\t" + "uuidValue:" + uuidValue);

        while (!stringRedisTemplate.execute(new DefaultRedisScript<>(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) {
            //æš‚åœ60æ¯«ç§’
            try {
                TimeUnit.MILLISECONDS.sleep(60);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        //æ–°å»ºä¸€ä¸ªåå°æ‰«æç¨‹åºï¼Œæ¥æ£€æµ‹keyç›®å‰çš„ttlï¼Œæ˜¯å¦åˆ°æˆ‘ä»¬è§„å®šçš„1/2 1/3æ¥å®ç°ç»­æœŸ
        renewExpire();
        return true;
    }
    return false;
}
```

#### æ€»ç»“

- **é”é‡Šæ”¾é—®é¢˜**ï¼šä»…ä½¿ç”¨ `setnx` åŠ é”è€Œæœªé‡Šæ”¾é”ï¼Œè‹¥å‡ºç°å¼‚å¸¸ï¼Œå¯èƒ½æ— æ³•é‡Šæ”¾é”ï¼Œå› æ­¤éœ€åœ¨ä»£ç å±‚é¢çš„ `finally` å—ä¸­é‡Šæ”¾é”ã€‚ä½†å¦‚æœæœåŠ¡å™¨å®•æœºï¼Œä»£ç æ— æ³•èµ°åˆ° `finally` å—ï¼Œä»æ— æ³•ä¿è¯è§£é”ï¼Œæ‰€ä»¥è¦ç»™é”çš„ `key` è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚
- **å‘½ä»¤åŸå­æ€§é—®é¢˜**ï¼šä¸ºä¿è¯è®¾ç½®é”å’Œè¿‡æœŸæ—¶é—´çš„åŸå­æ€§ï¼Œ`setnx` å’Œè®¾ç½®è¿‡æœŸæ—¶é—´çš„æ“ä½œå¿…é¡»åœ¨åŒä¸€è¡Œã€‚
- **å®‰å…¨è§£é”é—®é¢˜**ï¼šè¦ç¡®ä¿åªèƒ½è‡ªå·±åˆ é™¤è‡ªå·±çš„é”ï¼Œé˜²æ­¢è¯¯åˆ ä»–äººçš„é”ï¼Œå¯å°† `unlock` æ“ä½œå˜ä¸º Lua è„šæœ¬ä»¥ä¿è¯åŸå­æ€§ã€‚
- **å¯é‡å…¥é—®é¢˜**ï¼šä¸ºè€ƒè™‘å¯é‡å…¥æ€§ï¼Œå¯ç”¨ `hset` æ›¿ä»£ `setnx`ï¼Œå¹¶ä¸”å°†æ•´ä¸ªåŠ é”è¿‡ç¨‹å˜ä¸º Lua è„šæœ¬ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚
- **ç»­æœŸé—®é¢˜**ï¼šä¸ºé˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„è¿‡æœŸæ—¶é—´ï¼Œéœ€è¦æ·»åŠ è‡ªåŠ¨ç»­æœŸæœºåˆ¶ ã€‚

ä»¥ä¸Šåªæ˜¯è§£å†³äº†å•ä¸ªRedisæœåŠ¡å™¨çš„åŠ é”ï¼ŒåŒæ—¶è¿˜ä¼šå­˜åœ¨é›†ç¾¤ä¸‹çš„ç½‘ç»œåˆ†åŒºé—®é¢˜ã€‚è¿™é‡Œå°±éœ€è¦äº†ä¸‹RedLockç®—æ³•äº†
#### Redlock ä»‹ç»

- **åŸºæœ¬æ€æƒ³**ï¼šä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒRedis æ¨å‡º Redlockï¼Œé€‚ç”¨äºé›†ç¾¤ç¯å¢ƒã€‚éƒ¨ç½²å¤šä¸ªï¼ˆé€šå¸¸ 5 ä¸ªï¼‰Redis å®ä¾‹ï¼Œå®¢æˆ·ç«¯åœ¨å¤šæ•°ï¼ˆè‡³å°‘ 3 ä¸ªï¼‰å®ä¾‹ä¸Šè¯·æ±‚é”ï¼Œä¸€å®šæ—¶é—´å†…æˆåŠŸåˆ™åŠ é”æˆåŠŸï¼Œå¯æä¾›æ›´é«˜å®¹é”™æ€§ã€‚
- **å®ç°æµç¨‹**ï¼šå®¢æˆ·ç«¯åœ¨æœ‰é™æ—¶é—´ï¼ˆé€šå¸¸ä¸ºé”çš„è¿‡æœŸæ—¶é—´ï¼‰å†…å°è¯•åœ¨æ¯ä¸ª Redis å®ä¾‹ä¸ŠåŠ é”ï¼Œè‹¥å¤šæ•°ï¼ˆN/2 + 1ï¼‰å®ä¾‹åŠ é”æˆåŠŸï¼Œåˆ™åŠ é”æˆåŠŸï¼›å¦åˆ™é‡Šæ”¾å·²åŠ é”å®ä¾‹ï¼Œé‡æ–°å°è¯• ã€‚
- **ç¼ºç‚¹**ï¼š

- **å¤æ‚æ€§**ï¼šéœ€å¤šä¸ª Redis å®ä¾‹ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚æ€§å’Œç»´æŠ¤æˆæœ¬ã€‚
- **æ—¶é—´åŒæ­¥ä¾èµ–**ï¼šä¾èµ–å¤šä¸ªèŠ‚ç‚¹ç³»ç»Ÿæ—¶é—´ä¸€è‡´ï¼Œæ—¶é—´ä¸åŒæ­¥å¯èƒ½å½±å“é”æœ‰æ•ˆæ€§ã€‚
- **ä¸é€‚ç”¨äºé«˜å¹¶å‘**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè®¿é—®å¤šä¸ªå®ä¾‹è·å–é”ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
- **é”çš„ç»­æœŸé—®é¢˜**ï¼šé•¿æ—¶é—´æ“ä½œéœ€æ‰‹åŠ¨ç»­æœŸé”ï¼Œæ¶‰åŠå¤šä¸ªå®ä¾‹ï¼Œå¢åŠ å®ç°å¤æ‚åº¦å’Œé£é™©ã€‚
## **Redis çš„ Red Lock æ˜¯ä»€ä¹ˆï¼Ÿä½ äº†è§£å—**

### æ€»ç»“åˆ†æ

- Red Lockï¼ˆçº¢é”ï¼‰æ˜¯ä¸€ç§åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆï¼Œç”¨äºè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸­ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§é—®é¢˜ã€‚
- ç”Ÿäº§ç¯å¢ƒé€šå¸¸é‡‡ç”¨ä¸»ä» + å“¨å…µæ–¹å¼éƒ¨ç½² Redisã€‚
- ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”æ—¶ï¼Œä¸»ä»åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œä»èŠ‚ç‚¹å¯èƒ½æœªåŒæ­¥ä¸»èŠ‚ç‚¹çš„é”ä¿¡æ¯ï¼Œå¯¼è‡´æ–°ä¸»èŠ‚ç‚¹æ— é”ä¿¡æ¯ã€‚
- å¦ä¸€ä¸šåŠ¡å¯èƒ½å› è¯¯ä»¥ä¸ºé”æœªè¢«å è€ŒæŠ¢åˆ°é”ï¼Œè¿›è€Œä¸åŸæŒæœ‰é”ä¸šåŠ¡åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºæ“ä½œä¸´ç•Œèµ„æºï¼Œå¼•å‘æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚
- Redis å®˜æ–¹æ¨å‡ºçº¢é”ï¼Œå¯é¿å…ä¸Šè¿°çŠ¶å†µï¼Œç¡®ä¿éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœæ—¶ä¸å½±å“é”çš„ä½¿ç”¨å’Œæ•°æ®çš„æ­£ç¡®æ€§ã€‚

### æ‰©å±•çŸ¥è¯†

- **çº¢é”éƒ¨ç½²è¦æ±‚**ï¼šä½¿ç”¨çº¢é”éœ€é›†ç¾¤éƒ¨ç½² Redisï¼Œå®˜æ–¹æ¨èè‡³å°‘ 5 ä¸ªä¸»åº“å®ä¾‹ï¼Œæ— éœ€ä»åº“å’Œå“¨å…µï¼Œå®ä¾‹é—´æ— å…³ç³»ã€æ— éœ€ä¿¡æ¯äº¤äº’ã€‚
- **çº¢é”ç”³è¯·æœºåˆ¶**ï¼šå®¢æˆ·ç«¯ä¾æ¬¡å‘ 5 ä¸ªå®ä¾‹ç”³è¯·é”ï¼ŒæˆåŠŸç”³è¯·æ•°é‡è¶…è¿‡åŠæ•°ï¼ˆ>=3ï¼‰åˆ™çº¢é”ç”³è¯·æˆåŠŸï¼Œå¦åˆ™å¤±è´¥ã€‚è‹¥æœ‰å®ä¾‹å®•æœºï¼Œä¸å½±å“ç”³è¯·ï¼Œç†è®ºæˆåŠŸæ•°å¯è¾¾ 4 ä¸ªã€‚æ²¡æœ‰ä¸»ä»æœºåˆ¶ï¼Œé¿å…åŒæ­¥ä¸¢å¤±é”é—®é¢˜ã€‚
- **åŠ é”æµç¨‹**ï¼š

1. å®¢æˆ·ç«¯è·å–å½“å‰æ—¶é—´ï¼ˆt1ï¼‰ã€‚
2. æŒ‰é¡ºåºå¯¹ N ä¸ª Redis èŠ‚ç‚¹ç”¨ set å‘½ä»¤åŠ é”ï¼Œè®¾ç½®çŸ­è¶…æ—¶æ—¶é—´ï¼ˆè¿œå°äºé”æ€»è¿‡æœŸæ—¶é—´ï¼‰ï¼Œè¯·æ±‚è¶…æ—¶åˆ™ç«‹å³å‘ä¸‹ä¸€èŠ‚ç‚¹ç”³è¯·ã€‚
3. æˆåŠŸä»åŠæ•°èŠ‚ç‚¹è·é”åï¼Œè·å–å½“å‰æ—¶é—´ t2ï¼Œè®¡ç®—åŠ é”æ€»è€—æ—¶ tï¼ˆt2 - t1ï¼‰ã€‚è‹¥ t < é”è¿‡æœŸæ—¶é—´ï¼ŒåŠ é”æˆåŠŸï¼Œå¦åˆ™å¤±è´¥ã€‚
4. åŠ é”æˆåŠŸæ‰§è¡Œä¸šåŠ¡ï¼Œå¤±è´¥åˆ™å‘å…¨éƒ¨èŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”æµç¨‹ã€‚

#### ä¼˜ç‚¹

- **é«˜å®¹é”™æ€§**ï¼šåŸºäºå¤šä¸ªç‹¬ç«‹ Redis ä¸»èŠ‚ç‚¹ï¼ˆè‡³å°‘ 5 ä¸ªï¼‰ï¼Œéƒ¨åˆ†èŠ‚ç‚¹æ•…éšœæ—¶ä»èƒ½ä¿è¯åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹æ­£å¸¸å·¥ä½œï¼Œå¯è·å–é”ï¼Œç³»ç»Ÿå®¹é”™èƒ½åŠ›å¼ºã€‚
- **é¿å…åŒæ­¥é—®é¢˜**ï¼šä¸ä¾èµ–ä¸»ä»æ¶æ„ï¼Œæ— ä¸»ä»åŒæ­¥å»¶è¿Ÿå¯¼è‡´çš„é”å®‰å…¨é—®é¢˜ï¼Œé”å¯é æ€§å’Œå®‰å…¨æ€§é«˜ã€‚
- **é€‚åº”åˆ†å¸ƒå¼**ï¼šé€‚ç”¨äºåˆ†å¸ƒå¼åœºæ™¯ï¼Œèƒ½åœ¨å¤šèŠ‚ç‚¹é—´å®ç°æœ‰æ•ˆé”æ§åˆ¶ï¼Œæ»¡è¶³åˆ†å¸ƒå¼åº”ç”¨å¯¹é”çš„éœ€æ±‚ã€‚

#### ç¼ºç‚¹

- **å¤æ‚æ€§é«˜**ï¼šéœ€éƒ¨ç½²å¤šä¸ªç‹¬ç«‹ Redis ä¸»èŠ‚ç‚¹ï¼Œå¢åŠ éƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬ï¼Œå®ç°ä¸è¿ç»´æ›´å¤æ‚ã€‚
- **æ€§èƒ½å¼€é”€å¤§**ï¼šå®¢æˆ·ç«¯å‘å¤šèŠ‚ç‚¹ä¾æ¬¡å‘é€åŠ é”è¯·æ±‚ï¼Œç½‘ç»œé€šä¿¡å’Œè¯·æ±‚å¤„ç†æ—¶é—´å¢åŠ ï¼Œé«˜å¹¶å‘ä¸‹æ€§èƒ½ä¸‹é™ã€æ•ˆç‡ä½ã€‚
- **ä¾èµ–æ—¶é’ŸåŒæ­¥**ï¼šè¿è¡Œä¾èµ–å„èŠ‚ç‚¹æ—¶é’ŸåŒæ­¥ï¼Œæ—¶é’Ÿåå·®å¤§æ—¶ä¼šå½±å“é”æœ‰æ•ˆæ€§ï¼Œå½±å“ç³»ç»Ÿæ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚
- **é”ç»­æœŸå¤æ‚**ï¼šé•¿æ—¶é—´ä¸šåŠ¡æ“ä½œä¸­é”ç»­æœŸéœ€åè°ƒå¤šä¸ªèŠ‚ç‚¹ï¼Œå®ç°éš¾åº¦å¤§ï¼Œæ˜“å¼•å…¥æ½œåœ¨é—®é¢˜ ã€‚

#### çº¢é”ä¸€å®šå®‰å…¨ä¹ˆï¼Ÿ

![](https://cdn.nlark.com/yuque/0/2025/png/26566882/1736079114551-8e709613-c76b-4692-bfbf-92c9358f7a1e.png)

1. `Client 1`å‘`Lock service`è¯·æ±‚è·å–é”ï¼ˆ`get lease`ï¼‰ï¼Œ`Lock service`è¿”å›`ok`ï¼Œè¡¨ç¤º`Client 1`æˆåŠŸè·å–é”ã€‚
2. `Client 1`å‘ç”Ÿäº†`stop-the-world GC pause`ï¼ˆåœæ­¢ä¸–ç•Œçš„åƒåœ¾å›æ”¶æš‚åœï¼‰ï¼Œåœ¨æ­¤æœŸé—´ï¼Œ`Lock service`è®¤ä¸º`Client 1`çš„é”ç§Ÿèµï¼ˆ`lease`ï¼‰å·²è¿‡æœŸã€‚
3. `Client 2`å‘`Lock service`è¯·æ±‚è·å–é”ï¼ˆ`get lease`ï¼‰ï¼Œ`Lock service`è¿”å›`ok`ï¼Œ`Client 2`æˆåŠŸè·å–é”ã€‚
4. `Client 2`å‘`Storage`å†™å…¥æ•°æ®ï¼ˆ`write data`ï¼‰ï¼Œ`Storage`è¿”å›`ok`ï¼Œè¡¨ç¤ºå†™å…¥æˆåŠŸã€‚
5. `Client 1`çš„åƒåœ¾å›æ”¶æš‚åœç»“æŸåï¼Œå®ƒè®¤ä¸ºè‡ªå·±ä»ç„¶æŒæœ‰é”ï¼Œäºæ˜¯ä¹Ÿå‘`Storage`å†™å…¥æ•°æ®ï¼Œä½†æ­¤æ—¶å¯èƒ½ä¼šå‡ºç°æ•°æ®å†²çªæˆ–é”™è¯¯

è¿™é‡Œæˆ‘é—®äº†aiä¸€äº›ç›¸å…³çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æ„Ÿè§‰å¹¶ä¸æ˜¯æ¯ä¸ªæ–¹æ¡ˆéƒ½åˆç†ï¼ˆä»…ä½œå‚è€ƒï¼‰

- **å»¶é•¿é”æœ‰æ•ˆæœŸ**ï¼šå¢åŠ é”åœ¨ Redis ä¸­çš„æœ‰æ•ˆæ—¶é•¿ï¼Œé™ä½å›  GC è‡´é”è¿‡æœŸæ¦‚ç‡ï¼Œä½†è¿‡é•¿ä¼šå½±å“å¹¶å‘æ€§èƒ½ã€‚
- **å¼•å…¥ç»­ç§Ÿæœºåˆ¶**ï¼šè·å–é”åå¯åŠ¨åå°çº¿ç¨‹æˆ–å®šæ—¶ä»»åŠ¡å®šæœŸç»­ç§Ÿï¼Œå¦‚ Redisson çš„ Watch Dog æœºåˆ¶ã€‚
- **å¢å”¯ä¸€æ ‡è¯†æ ¡éªŒ**ï¼šåŠ é”æ—¶ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼Œæ‰§è¡Œé€»è¾‘å‰æ£€æŸ¥æ ‡è¯†æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™é‡æ–°å¤„ç†ã€‚
- **ä¼˜åŒ– GC ç­–ç•¥**ï¼šè°ƒæ•´ JVM GC å‚æ•°ï¼Œå¦‚ä½¿ç”¨é«˜æ•ˆç®—æ³•ã€è°ƒæ•´å †å†…å­˜ç­‰ï¼Œå‡å°‘ GC æš‚åœæ—¶é—´ã€‚
- **åˆ†å¸ƒå¼äº‹åŠ¡ä¿éšœ**ï¼šå°†ç›¸å…³æ“ä½œå°è£…åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œåˆ©ç”¨å…¶åŸå­æ€§ï¼Œå¼‚å¸¸æ—¶äº‹åŠ¡å›æ»šã€‚
- **åˆ©ç”¨æ¡†æ¶é«˜çº§ç‰¹æ€§**ï¼šå¦‚ Redisson æä¾›å¤šç§è·å–é”æ¨¡å¼å’Œé‡è¯•ç­–ç•¥ï¼Œå¯æŒ‰éœ€é…ç½®ã€‚

ç„¶åå°±æ˜¯è¿˜æœ‰å¯èƒ½å‘ç”Ÿæ—¶é’Ÿæ¼‚ç§»é—®é¢˜ï¼ŒåŒæ ·é€šè¿‡è¯¢é—®aiåšäº†è§£å†³æ–¹æ¡ˆ

- **åè®®åŒæ­¥**ï¼šä½¿ç”¨ NTP åè®®ï¼Œé€šè¿‡ä¸ NTP æœåŠ¡å™¨é€šä¿¡è·å–å‡†ç¡®æ—¶é—´æ¥è°ƒæ•´æœ¬åœ°æ—¶é’Ÿï¼›å¯¹äºé«˜ç²¾åº¦åœºæ™¯ï¼Œé‡‡ç”¨ PTP åè®®ï¼Œå€ŸåŠ©ç¡¬ä»¶ä¸è½¯ä»¶ååŒå®ç°äºšå¾®ç§’çº§åŒæ­¥ã€‚
- **å®šæœŸæ ¡å‡†**ï¼šå³ä¾¿ä½¿ç”¨åŒæ­¥åè®®ï¼Œä»å®šæœŸï¼ˆå¦‚æ¯å¤©æˆ–æ¯å‘¨ï¼‰æ‰‹åŠ¨æˆ–è‡ªåŠ¨æ ¡å‡†æ—¶é’Ÿï¼Œä¿éšœæ—¶é’Ÿå‡†ç¡®æ€§ã€‚
- **ç¡¬ä»¶åŒæ­¥**ï¼šå¯¹æ—¶é—´ç²¾åº¦è¦æ±‚æé«˜çš„åœºæ™¯ï¼Œåˆ©ç”¨ GPS æ—¶é’ŸæœåŠ¡å™¨ã€åŸå­é’Ÿç­‰ä¸“ä¸šç¡¬ä»¶è®¾å¤‡æä¾›ç²¾ç¡®æ—¶é—´ä¿¡å·ï¼Œå®ç°èŠ‚ç‚¹æ—¶é—´åŒæ­¥ã€‚
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹ç›‘æ§æœºåˆ¶å®æ—¶ç›‘æµ‹æ—¶é’Ÿåå·®ï¼Œè®¾ç½®é˜ˆå€¼ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶åŠæ—¶å‘Šè­¦é€šçŸ¥ç®¡ç†å‘˜å¤„ç†ã€‚
- **æ¶æ„è®¾è®¡**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­é‡‡ç”¨å®¹é”™æœºåˆ¶å’Œç®—æ³•ï¼Œå¦‚åˆ†å¸ƒå¼é”ç»“åˆé”è·å–é¡ºåºç­‰å› ç´ ã€åˆ†å¸ƒå¼æ•°æ®åº“ä½¿ç”¨åŸºäºç‰ˆæœ¬å·æˆ–é€»è¾‘æ—¶é’Ÿçš„å¹¶å‘æ§åˆ¶ï¼Œå‡å°‘å¯¹ç‰©ç†æ—¶é’Ÿä¾èµ– ã€‚

ä½†æ˜¯å¯¹äºä»¥ä¸Šæ–¹æ¡ˆä¸­çš„ç›¸å…³çŸ¥è¯†å¹¶ä¸äº†è§£ï¼Œåˆè¿›è¡Œäº†ç½‘ä¸ŠæœæŸ¥ï¼Œæ‰¾åˆ°ä¸€ç¯‡ç›¸å…³æ–‡ç« ï¼ˆ**å†…å®¹æœ‰ç‚¹å¤æ‚ï¼Œæš‚åšäº†è§£ï¼Œåç»­å†åšæ·±å…¥å­¦ä¹ **ï¼‰

[ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€‘Ch 6 åŒæ­¥ Synchronization ï¼ˆæ—¶é’ŸåŒæ­¥ã€äº’æ–¥ã€é€‰ä¸¾ï¼‰_ntpé€‰ä¸¾ç®—æ³•-CSDNåšå®¢](https://blog.csdn.net/qq_41283356/article/details/124964332?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-124964332-blog-113695334.235^v43^pc_blog_bottom_relevance_base5&spm=1001.2101.3001.4242.2&utm_relevant_index=4)

## Redis å®ç°åˆ†å¸ƒå¼é”æ—¶å¯èƒ½é‡åˆ°çš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ

### æ€»ç»“åˆ†æ

1. ä¸šåŠ¡æœªæ‰§è¡Œå®Œï¼Œé”å·²åˆ°æœŸ
2. å•ç‚¹æ•…éšœé—®é¢˜
3. ä¸»ä»é—®é¢˜ä¸åŒæ­¥é—®é¢˜
4. ç½‘ç»œåˆ†åŒºé—®é¢˜
5. æ—¶é’Ÿæ¼‚ç§»é—®é¢˜
6. é”çš„å¯é‡å…¥æ€§é—®é¢˜
7. è¯¯é‡Šæ”¾é”é—®é¢˜

### æ‰©å±•çŸ¥è¯†

- **ä¸šåŠ¡æœªæ‰§è¡Œå®Œï¼Œé”å·²åˆ°æœŸ**ï¼šä¸ºé˜²é”æ— æ³•æ­£å¸¸é‡Šæ”¾éœ€è®¾è¿‡æœŸæ—¶é—´ï¼Œå´å¯èƒ½å¯¼è‡´ä¸šåŠ¡æœªå®Œæˆé”å·²è¿‡æœŸã€‚å¯é‡‡ç”¨ç»­çº¦æœºåˆ¶ï¼ˆå¦‚ Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ï¼‰ï¼Œç”±å®ˆæŠ¤çº¿ç¨‹åˆ¤æ–­ä¸šåŠ¡æ‰§è¡Œæƒ…å†µå¹¶é€‚æ—¶ç»­çº¦ã€‚åŒæ—¶ï¼Œè¦åˆç†è¯„ä¼°è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…å½±å“ Redis æ€§èƒ½æˆ–å‡ºç°é”æå‰è¿‡æœŸé—®é¢˜ã€‚
- **å•ç‚¹æ•…éšœé—®é¢˜**ï¼šRedis å•æœºéƒ¨ç½²æ—¶ï¼Œå®ä¾‹å®•æœºæˆ–ä¸å¯ç”¨ä¼šä½¿åˆ†å¸ƒå¼é”æœåŠ¡æ— æ³•å·¥ä½œï¼Œé˜»ç¢ä¸šåŠ¡æ‰§è¡Œã€‚
- **ä¸»ä»é—®é¢˜**ï¼šä¸»ä» + å“¨å…µéƒ¨ç½²çš„ Redis ä¸­ï¼Œä¸»ä»å¤åˆ¶å¼‚æ­¥ï¼Œä¸»èŠ‚ç‚¹è·å–é”åæœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹å°±å®•æœºï¼Œæ–°ä¸»èŠ‚ç‚¹æ— é”æ•°æ®ï¼Œä¼šå¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è·å–é”ã€‚
- **ç½‘ç»œåˆ†åŒº**ï¼šç½‘ç»œä¸ç¨³å®šæ—¶å®¢æˆ·ç«¯ä¸ Redis è¿æ¥ä¸­æ–­ï¼Œæœªè®¾è¿‡æœŸæ—¶é—´ä¼šè‡´é”æ— æ³•é‡Šæ”¾ï¼Œå¤šä¸ªé”è¿˜å¯èƒ½å¼•å‘æ­»é”ã€‚
- **æ—¶é’Ÿæ¼‚ç§»**ï¼šRedis åˆ†å¸ƒå¼é”ä¾å®ä¾‹æ—¶é—´åˆ¤æ–­è¿‡æœŸï¼Œæ—¶é’Ÿæ¼‚ç§»å¯èƒ½ä½¿é”å¤±æ•ˆï¼Œå¯é€šè¿‡ NTP æœåŠ¡åŒæ­¥æ‰€æœ‰èŠ‚ç‚¹ç³»ç»Ÿæ—¶é’Ÿæ¥å‡å°‘å½±å“ã€‚

ä»¥ä¸Šæ‰©å±•è§£å†³æ–¹æ¡ˆå¯å‚è€ƒä»¥ä¸‹æ–‡æ¡£çš„æ‰©å±•åˆ†æ

[Redis çš„ Red Lock æ˜¯ä»€ä¹ˆï¼Ÿä½ äº†è§£å—ï¼Ÿ - æœ¨å­é‡‘åˆäºŒä¸¨çš„å›ç­”è®°å½• - é¢è¯•é¸­ - ç¨‹åºå‘˜æ±‚èŒé¢è¯•åˆ·é¢˜ç¥å™¨](https://www.mianshiya.com/answer/1826085029072973825/question-answer/1875881520580595714?questionId=1780933295664558082)

[Redis ä¸­å¦‚ä½•å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ - æœ¨å­é‡‘åˆäºŒä¸¨çš„å›ç­”è®°å½• - é¢è¯•é¸­ - ç¨‹åºå‘˜æ±‚èŒé¢è¯•åˆ·é¢˜ç¥å™¨](https://www.mianshiya.com/answer/1826085029072973825/question-answer/1875861401376722946?questionId=1780933295660363778)